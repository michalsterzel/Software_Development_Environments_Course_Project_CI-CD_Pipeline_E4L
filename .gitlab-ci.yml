# ============================================================
# Root GitLab CI/CD Pipeline Configuration
# Infrastructure Owner: Michal
# ============================================================
# This file orchestrates the entire CI/CD flow across all teams.
# It defines pipeline stages and includes team-specific job definitions.
#
# OWNERSHIP BOUNDARIES:
# - This file: Michal (Infrastructure & CI/CD)
# - .ci/backend.yml: Jabin (Backend team)
# - .ci/frontend.yml: Maksym (Frontend team)
# - .ci/deploy.yml: Michal (Deployment orchestration)
#
# DO NOT modify job logic in included files unless you own that component.
# ============================================================

# ============================================================
# PIPELINE STAGES
# ============================================================
# Stages execute in order. Jobs in the same stage run in parallel.
# Failure in any stage blocks progression to the next stage.
#
# Stage ownership:
# - build: Backend & Frontend teams (compile, install dependencies)
# - unit_test: Backend & Frontend teams (run unit tests)
# - image: Backend & Frontend teams (build Docker images)
# - deploy_staging: Infrastructure (deploy to staging environment)
# - integration_test: Infrastructure (validate staging deployment)
# - deploy_prod: Infrastructure (deploy to production, manual gate)
# ============================================================

stages:
  - build          # Compile application code, install dependencies
  - unit_test      # Run unit tests (must pass before images are built)
  - image          # Build and push Docker images to GitLab Container Registry
  - deploy_staging # Deploy images to staging environment
  - integration_test # Run integration tests against staging
  - deploy_prod    # Deploy to production (requires manual approval)

# ============================================================
# INCLUDE TEAM-SPECIFIC CI CONFIGURATIONS
# ============================================================
# Each team maintains their own CI job definitions.
# Infrastructure orchestrates when jobs run via stage dependencies.

include:
  # Backend CI jobs (Jabin) - Integrated January 2026
  - local: ".ci/backend.yml"
  # Frontend CI jobs (Maksym) - Integrated January 2026
  - local: ".ci/frontend.yml"
  # Deployment jobs (Michal) - Backend deployment active, frontend commented out
  - local: ".ci/deploy.yml"

# ============================================================
# DEFAULT CONFIGURATION
# ============================================================
# Applied to all jobs unless overridden

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  CI_REGISTRY: "192.168.56.10:5050"
  CI_REGISTRY_IMAGE: "192.168.56.10:5050/root/e4l"

default:
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# ============================================================
# PIPELINE EXECUTION RULES
# ============================================================
# Define when the pipeline should run

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "dummy-tests"'
    - if: '$CI_COMMIT_BRANCH == "backend-integration"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# ============================================================
# SMOKE TEST (Infrastructure Validation)
# ============================================================
# COMMENTED OUT: Dummy test phase complete, real backend pipeline active.
# Keep this code as reference for troubleshooting runner connectivity.
#
# Verifies GitLab Runner connectivity and basic CI setup.
# Does not block backend/frontend jobs.

# ci_smoke_test:
#   stage: build
#   script:
#     - echo "========================================"
#     - echo "CI Pipeline Smoke Test"
#     - echo "========================================"
#     - echo "Pipeline triggered successfully"
#     - echo "Runner hostname:"
#     - hostname
#     - echo "Working directory:"
#     - pwd
#     - echo "GitLab CI Variables available:"
#     - echo "CI_COMMIT_SHA = ${CI_COMMIT_SHA}"
#     - echo "CI_REGISTRY = ${CI_REGISTRY}"
#     - echo "CI_REGISTRY_IMAGE = ${CI_REGISTRY_IMAGE}"
#     - echo "========================================"
#   allow_failure: true  # Don't block pipeline if smoke test has issues

# ============================================================
# BEGIN DUMMY CI TEST - Infrastructure Validation Only
# ============================================================
# This section is for temporary infrastructure validation.
# It proves the full CI/CD pipeline works with dummy images.
#
# TO REMOVE: Delete the entire section between 
# "BEGIN DUMMY CI TEST" and "END DUMMY CI TEST" markers.
#
# These jobs use nginx:alpine as placeholder images and do NOT
# interact with real backend/frontend code.
# ============================================================

# ============================================================
# Dummy Image Jobs (Staging)
# ============================================================
# COMMENTED OUT: Dummy test phase complete, real backend images now built.
# Keep this code as reference for infrastructure testing patterns.
#
# Build and push dummy images using nginx:alpine as placeholder

# dummy_backend_image:
#   stage: image
#   image: docker:24-cli
#   services:
#     - name: docker:24-dind
#       command: ["--insecure-registry=192.168.56.10:5050"]
#   before_script:
#     - echo "Logging into registry ${CI_REGISTRY}"
#     - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY}
#   script:
#     - |
#       echo "Building dummy backend image..."
#       docker pull nginx:alpine
#       docker tag nginx:alpine ${CI_REGISTRY_IMAGE}/e4l-backend:dummy
#       docker push ${CI_REGISTRY_IMAGE}/e4l-backend:dummy
#       echo "Dummy backend image pushed: ${CI_REGISTRY_IMAGE}/e4l-backend:dummy"

# dummy_frontend_image:
#   stage: image
#   image: docker:24-cli
#   services:
#     - name: docker:24-dind
#       command: ["--insecure-registry=192.168.56.10:5050"]
#   before_script:
#     - echo "Logging into registry ${CI_REGISTRY}"
#     - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY}
#   script:
#     - |
#       echo "Building dummy frontend image..."
#       docker pull nginx:alpine
#       docker tag nginx:alpine ${CI_REGISTRY_IMAGE}/e4l-frontend:dummy
#       docker push ${CI_REGISTRY_IMAGE}/e4l-frontend:dummy
#       echo "Dummy frontend image pushed: ${CI_REGISTRY_IMAGE}/e4l-frontend:dummy"

# ============================================================
# Dummy Staging Deployment
# ============================================================
# COMMENTED OUT: Dummy test phase complete, real backend deployment active.
# Keep this code as reference for deployment and testing patterns.

# deploy_staging_dummy:
#   stage: deploy_staging
#   image: docker:24-cli
#   services:
#     - name: docker:24-dind
#       command: ["--insecure-registry=192.168.56.10:5050"]
#   before_script:
#     - apk add --no-cache bash curl
#   script:
#     - |
#       echo "=== Dummy Staging Deployment ==="
#       export BACKEND_IMAGE="${CI_REGISTRY_IMAGE}/e4l-backend:dummy"
#       export FRONTEND_IMAGE="${CI_REGISTRY_IMAGE}/e4l-frontend:dummy"
#       echo "Backend image: ${BACKEND_IMAGE}"
#       echo "Frontend image: ${FRONTEND_IMAGE}"
#       cd infra/staging
#       docker compose down || true
#       docker compose pull
#       docker compose up -d
#       echo "Waiting for services to stabilize..."
#       sleep 10
#       docker compose ps
#       echo ""
#       echo "=== Running Integration Tests ==="
#       echo "Waiting for services to respond..."
#       sleep 5
#       echo ""
#       echo "[TEST 1/2] Testing backend HTTP endpoint..."
#       docker compose exec -T backend curl -f http://localhost:8080/ || echo "Note: Backend may need /health endpoint"
#       echo ""
#       echo "[TEST 2/2] Testing frontend HTTP endpoint..."
#       docker compose exec -T frontend curl -f http://localhost:80/
#       echo ""
#       echo "=== Integration Tests Complete ==="
#   needs:
#     - dummy_backend_image
#     - dummy_frontend_image
#   environment:
#     name: staging_dummy

# ============================================================
# Dummy Production Deployment
# ============================================================
# COMMENTED OUT: Dummy test phase complete, real backend deployment active.
# Keep this code as reference for production deployment patterns.

# deploy_prod_dummy:
#   stage: deploy_prod
#   image: docker:24-cli
#   services:
#     - name: docker:24-dind
#       command: ["--insecure-registry=192.168.56.10:5050"]
#   before_script:
#     - apk add --no-cache bash curl
#   script:
#     - |
#       echo "=== Dummy Production Deployment ==="
#       export BACKEND_IMAGE="${CI_REGISTRY_IMAGE}/e4l-backend:dummy"
#       export FRONTEND_IMAGE="${CI_REGISTRY_IMAGE}/e4l-frontend:dummy"
#       echo "Backend image: ${BACKEND_IMAGE}"
#       echo "Frontend image: ${FRONTEND_IMAGE}"
#       echo ""
#       echo "WARNING: Deploying dummy images to production"
#       cd infra/prod
#       docker compose down || true
#       docker compose pull
#       docker compose up -d
#       echo "Waiting for services to stabilize..."
#       sleep 10
#       docker compose ps
#       echo ""
#       echo "Validating production deployment..."
#       docker compose exec -T backend curl -f http://localhost:8080/ || echo "Production validation check"
#       docker compose exec -T frontend curl -f http://localhost:80/
#   needs:
#     - deploy_staging_dummy
#   when: manual
#   environment:
#     name: prod_dummy

# ============================================================
# END DUMMY CI TEST
# ============================================================

