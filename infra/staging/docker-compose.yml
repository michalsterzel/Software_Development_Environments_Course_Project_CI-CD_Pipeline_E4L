# ============================================================
# Staging Environment Docker Compose
# ============================================================
# Owner: Michal (Infrastructure & CI/CD)
# Backend Support: Jabin
#
# PURPOSE:
# Production-like environment for integration testing.
# Deployed automatically by CI/CD pipeline after successful builds.
#
# This environment uses Docker images built and pushed by the CI pipeline.
# Images are pulled from GitLab Container Registry.
#
# PORT ASSIGNMENTS:
# - Backend:  host 8081 → container 8080
# - Frontend: host 3001 → container 80
# - MySQL:    host 3307 → container 3306
#
# DATABASE:
# Separate staging database: e4l_staging
# Isolated from dev and production databases.
# ============================================================

version: '3.8'

services:
  backend:
    # Image is set via CI_REGISTRY_IMAGE environment variable
    # Format: registry.example.com/namespace/project/backend:commit-sha
    # Original production image (commented for dummy test validation):
    # image: ${BACKEND_IMAGE:-registry.gitlab.com/e4l/platform/backend:latest}
    # BEGIN DUMMY CI TEST
    image: ${BACKEND_IMAGE:-registry.gitlab.com/e4l/platform/e4l-backend:dummy}
    # END DUMMY CI TEST
    ports:
      - "8081:8080"
    environment:
      - DB_HOST=db
      - DB_PORT=3306
      - DB_NAME=e4l_staging
      - DB_USER=staginguser
      - DB_PASSWORD=stagingpass
      # Backend team: Ensure CI/CD variables are configured in GitLab
      # (JWT_SECRET, SIGNATURE_KEY, ADMIN_EMAIL, etc.)
    depends_on:
      - db
    networks:
      - staging-network
    restart: on-failure

  frontend:
    # Image is set via CI_REGISTRY_IMAGE environment variable
    # Original production image (commented for dummy test validation):
    # image: ${FRONTEND_IMAGE:-registry.gitlab.com/e4l/platform/frontend:latest}
    # BEGIN DUMMY CI TEST
    image: ${FRONTEND_IMAGE:-registry.gitlab.com/e4l/platform/e4l-frontend:dummy}
    # END DUMMY CI TEST
    ports:
      - "3001:80"
    environment:
      - BACKEND_URL=http://backend:8080
    depends_on:
      - backend
    networks:
      - staging-network
    restart: on-failure

  db:
    image: mysql:8.0
    ports:
      - "3307:3306"
    environment:
      - MYSQL_DATABASE=e4l_staging
      - MYSQL_USER=staginguser
      - MYSQL_PASSWORD=stagingpass
      - MYSQL_ROOT_PASSWORD=rootpass_staging
    volumes:
      - staging-db-data:/var/lib/mysql
    networks:
      - staging-network
    command: --default-authentication-plugin=mysql_native_password

volumes:
  staging-db-data:

networks:
  staging-network:
    driver: bridge
