# ============================================================
# Staging Environment Docker Compose
# ============================================================
# Owner: Michal (Infrastructure & CI/CD)
# Backend Support: Jabin
#
# PURPOSE:
# Production-like environment for integration testing.
# Deployed automatically by CI/CD pipeline after successful builds.
#
# This environment uses Docker images built and pushed by the CI pipeline.
# Images are pulled from GitLab Container Registry.
#
# PORT ASSIGNMENTS:
# - Backend:  host 8081 → container 8080
# - Frontend: host 3001 → container 80
# - MariaDB:  host 3307 → container 3306
#
# DATABASE:
# MariaDB with logical database: e4l_staging
# Isolated from dev and production databases.
# ============================================================

version: '3.8'

services:
  backend:
    # Image is set via BACKEND_IMAGE environment variable from CI
    # Format: ${CI_REGISTRY_IMAGE}/e4l-backend:${CI_COMMIT_SHA}
    # --- DUMMY IMAGE (for infrastructure testing) ---
    # image: ${BACKEND_IMAGE:-registry.gitlab.com/e4l/platform/e4l-backend:dummy}
    # --- REAL CI-BUILT IMAGE ---
    image: ${BACKEND_IMAGE:-192.168.56.10:5050/root/e4l/e4l-backend:latest}
    ports:
      - "8081:8080"
    environment:
      # Spring Boot datasource configuration for MariaDB
      - SPRING_DATASOURCE_URL=jdbc:mysql://db:3306/e4l_staging?createDatabaseIfNotExist=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=rootpass_staging
      # Application-specific environment variables
      - JWT_SECRET=${JWT_SECRET:-staging-jwt-secret-key-2025}
      - SIGNATURE_KEY=${SIGNATURE_KEY:-staging-signature-key-2025}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@e4l.lu}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      - RESOURCES_STATIC_URL=http://localhost:8081/e4lapi/
      - DEV_RESOURCES_STATIC_URL=http://localhost:8081/e4lapi/
      - TZ=Europe/Luxembourg
    depends_on:
      - db
    networks:
      - staging-network
    restart: on-failure
    # Allow DB to start before backend attempts connection
    entrypoint: ["/bin/sh", "-c", "sleep 15 && java -jar /app/app.jar"]

  frontend:
    # Image is set via FRONTEND_IMAGE environment variable from CI
    # --- DUMMY IMAGE (for infrastructure testing) ---
    # image: ${FRONTEND_IMAGE:-registry.gitlab.com/e4l/platform/e4l-frontend:dummy}
    # --- REAL CI-BUILT IMAGE ---
    image: ${FRONTEND_IMAGE:-192.168.56.10:5050/root/e4l/e4l-frontend:latest}
    ports:
      - "3001:80"
    environment:
      - BACKEND_URL=http://backend:8080
    depends_on:
      - backend
    networks:
      - staging-network
    restart: on-failure

  db:
    # --- OLD: MySQL 8.0 (replaced with MariaDB) ---
    # image: mysql:8.0
    # --- NEW: MariaDB 10.11 LTS ---
    image: mariadb:10.11
    container_name: staging-db
    ports:
      - "3307:3306"
    environment:
      - MARIADB_DATABASE=e4l_staging
      - MARIADB_ROOT_PASSWORD=rootpass_staging
      # Legacy MySQL env vars for compatibility
      - MYSQL_DATABASE=e4l_staging
      - MYSQL_ROOT_PASSWORD=rootpass_staging
    volumes:
      - staging-db-data:/var/lib/mysql
    networks:
      - staging-network

volumes:
  staging-db-data:

networks:
  staging-network:
    driver: bridge
