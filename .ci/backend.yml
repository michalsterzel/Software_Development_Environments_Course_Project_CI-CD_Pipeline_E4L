# ============================================================
# Backend CI Jobs
# ============================================================
# Owner: Jabin (Backend) / Integration: Michal (Infrastructure)
#
# This file defines backend build, test, and image creation jobs.
# It is included by the root .gitlab-ci.yml pipeline orchestration.
#
# Jobs:
#   - backend_build: Compile backend using Gradle
#   - backend_unit_test: Run unit tests
#   - backend_image: Build and push Docker image to registry
#
# Deployment is handled separately in .ci/deploy.yml
# ============================================================

# Build backend application
backend_build:
  stage: build
  image: gradle:8.5-jdk17
  script:
    - cd backend/backend_code
    - chmod +x gradlew
    - echo "Building backend..."
    - ./gradlew assemble -x test --no-daemon
  artifacts:
    paths:
      - backend/backend_code/build/
    expire_in: 1 hour

# Run backend unit tests
backend_unit_test:
  stage: unit_test
  image: gradle:8.5-jdk17
  script:
    - cd backend/backend_code
    - chmod +x gradlew
    - echo "Running backend unit tests..."
    - ./gradlew test --no-daemon
  artifacts:
    when: always
    paths:
      - backend/backend_code/build/reports/tests/test/
    reports:
      junit: backend/backend_code/build/test-results/test/**/TEST-*.xml
  dependencies:
    - backend_build

# Run backend integration tests (only integration package)
backend_integration_test:
  stage: integration_test
  image: gradle:8.5-jdk17
  script:
    - cd backend/backend_code
    - chmod +x gradlew
    - echo "Running backend integration tests (integration package only)..."
    - ./gradlew test --no-daemon --tests "lu.uni.e4l.platform.integration.*"
  artifacts:
    when: always
    paths:
      - backend/backend_code/build/reports/tests/test/
    reports:
      junit: backend/backend_code/build/test-results/test/**/TEST-*.xml
  needs:
    - backend_build
  allow_failure: false

# Build and push backend Docker image
backend_image:
  stage: image
  image: docker:24-cli
  services:
    - name: docker:24-dind
      command: ["--insecure-registry=192.168.56.10:5050"]
  before_script:
    - echo "Logging into registry ${CI_REGISTRY}"
    - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY}
  script:
    - cd backend
    - echo "Building backend Docker image..."
    - docker build -t ${CI_REGISTRY_IMAGE}/e4l-backend:${CI_COMMIT_SHA} .
    - docker tag ${CI_REGISTRY_IMAGE}/e4l-backend:${CI_COMMIT_SHA} ${CI_REGISTRY_IMAGE}/e4l-backend:latest
    - echo "Pushing backend image with tag ${CI_COMMIT_SHA}..."
    - docker push ${CI_REGISTRY_IMAGE}/e4l-backend:${CI_COMMIT_SHA}
    - docker push ${CI_REGISTRY_IMAGE}/e4l-backend:latest
  needs:
    - backend_build
    - backend_unit_test
