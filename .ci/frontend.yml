# ============================================================
# Frontend CI Jobs
# ============================================================
# Owner: Maksym (Frontend) / Integration: Michal (Infrastructure)
#
# This file defines frontend build, test, and image creation jobs.
# It is included by the root .gitlab-ci.yml pipeline orchestration.
#
# Jobs:
#   - frontend_build: Compile frontend using Webpack
#   - frontend_unit_test: Run unit tests
#   - frontend_image: Build and push Docker image to registry
#
# Deployment is handled separately in .ci/deploy.yml
# ============================================================

# Build frontend application
frontend_build:
  stage: build
  image: node:18-alpine
  script:
    - cd frontend/frontend_code
    - npm ci
    - echo "Building frontend with Webpack"
    - npm run build
  artifacts:
    paths:
      - frontend/frontend_code/e4l.frontend.docker/web/dist/
    expire_in: 1 hour

# Run frontend unit tests
frontend_unit_test:
  stage: unit_test
  image: node:18-alpine
  script:
    - cd frontend/frontend_code
    - npm ci
    - echo "Running frontend unit tests (unit tests only)"
    - npm run test:unit
  artifacts:
    when: always
    paths:
      - frontend/frontend_code/__tests__/
  dependencies:
    - frontend_build

# Run frontend integration tests against staging
frontend_integration_test:
  stage: integration_test
  image: node:18-alpine
  script:
    - cd frontend/frontend_code
    - npm ci
    - echo "Running frontend integration tests against staging"
    - export BACKEND_URL=http://192.168.56.10:8081
    - npm run test:integration
  artifacts:
    when: always
    paths:
      - frontend/frontend_code/__tests__/
  needs:
    - deploy_staging
  allow_failure: true  # Backend integration may fail if backend not ready

# Build and push frontend Docker image
frontend_image:
  stage: image
  image: docker:24-cli
  services:
    - name: docker:24-dind
      command: ["--insecure-registry=192.168.56.10:5050"]
  before_script:
    - echo "Logging into registry ${CI_REGISTRY}"
    - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY}
  script:
    - cd frontend
    - echo "Building frontend Docker image"
    - docker build -t ${CI_REGISTRY_IMAGE}/e4l-frontend:${CI_COMMIT_SHA} .
    - docker tag ${CI_REGISTRY_IMAGE}/e4l-frontend:${CI_COMMIT_SHA} ${CI_REGISTRY_IMAGE}/e4l-frontend:latest
    - echo "Pushing frontend image with tag ${CI_COMMIT_SHA}"
    - docker push ${CI_REGISTRY_IMAGE}/e4l-frontend:${CI_COMMIT_SHA}
    - docker push ${CI_REGISTRY_IMAGE}/e4l-frontend:latest
  needs:
    - frontend_build
    - frontend_unit_test
